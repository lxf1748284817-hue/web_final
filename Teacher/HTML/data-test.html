<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>数据持久化测试 - 大学成绩管理平台</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Noto Sans SC', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f6fa;
            color: #2c3e50;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            padding: 30px;
        }
        
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 2px solid #e0e6ed;
            border-radius: 8px;
            background: #f8f9fa;
        }
        
        .test-section h2 {
            color: #3498db;
            margin-top: 0;
        }
        
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-weight: bold;
        }
        
        .status.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status.info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .test-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background-color: #3498db;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #2980b9;
        }
        
        .btn-success {
            background-color: #27ae60;
            color: white;
        }
        
        .btn-success:hover {
            background-color: #219a52;
        }
        
        .btn-warning {
            background-color: #f39c12;
            color: white;
        }
        
        .btn-warning:hover {
            background-color: #d68910;
        }
        
        .btn-danger {
            background-color: #e74c3c;
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #c0392b;
        }
        
        .data-preview {
            max-height: 200px;
            overflow-y: auto;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            font-family: monospace;
            font-size: 12px;
        }
        
        .nav-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 30px;
        }
        
        .nav-button {
            display: inline-block;
            padding: 12px 24px;
            background-color: #3498db;
            color: white;
            text-decoration: none;
            border-radius: 6px;
            transition: background-color 0.3s;
        }
        
        .nav-button:hover {
            background-color: #2980b9;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1><i class="fas fa-database"></i> 数据持久化测试</h1>
        
        <div class="test-section">
            <h2><i class="fas fa-cogs"></i> 数据管理器状态</h2>
            <div id="managerStatus" class="status info">检查中...</div>
            <div class="test-buttons">
                <button class="btn-primary" onclick="checkDataManager()">
                    <i class="fas fa-sync"></i> 重新检查
                </button>
                <button class="btn-warning" onclick="forceReloadData()">
                    <i class="fas fa-redo"></i> 强制重新加载
                </button>
            </div>
        </div>
        
        <div class="test-section">
            <h2><i class="fas fa-book"></i> 课程数据测试</h2>
            <div id="courseDataStatus" class="status info">加载中...</div>
            <div id="courseDataPreview" class="data-preview"></div>
            <div class="test-buttons">
                <button class="btn-primary" onclick="loadCourseData()">
                    <i class="fas fa-download"></i> 重新加载课程数据
                </button>
                <button class="btn-success" onclick="createTestCourse()">
                    <i class="fas fa-plus"></i> 创建测试课程
                </button>
                <button class="btn-danger" onclick="clearAllCourses()">
                    <i class="fas fa-trash"></i> 清空所有课程
                </button>
            </div>
        </div>
        
        <div class="test-section">
            <h2><i class="fas fa-sync-alt"></i> 数据同步测试</h2>
            <div id="syncStatus" class="status info">等待测试...</div>
            <div class="test-buttons">
                <button class="btn-primary" onclick="triggerDataSync()">
                    <i class="fas fa-sync"></i> 手动同步数据
                </button>
                <button class="btn-warning" onclick="checkDataConsistency()">
                    <i class="fas fa-check-circle"></i> 检查数据一致性
                </button>
            </div>
        </div>
        
        <div class="test-section">
            <h2><i class="fas fa-exchange-alt"></i> 页面切换测试</h2>
            <div id="pageSwitchStatus" class="status info">准备测试...</div>
            <div class="test-buttons">
                <button class="btn-primary" onclick="testPageSwitch()">
                    <i class="fas fa-random"></i> 模拟页面切换
                </button>
                <button class="btn-success" onclick="openCoursesPage()">
                    <i class="fas fa-external-link-alt"></i> 打开课程管理页面
                </button>
            </div>
        </div>
        
        <div class="nav-buttons">
            <a href="dashboard.html" class="nav-button">
                <i class="fas fa-tachometer-alt"></i> 返回主面板
            </a>
            <a href="courses.html" class="nav-button">
                <i class="fas fa-book"></i> 课程管理
            </a>
        </div>
    </div>
    
    <script src="../JS/data.js"></script>
    <script src="../JS/data-sync.js"></script>
    <script>
        // 页面加载完成后执行测试
        document.addEventListener('DOMContentLoaded', function() {
            console.log('数据测试页面已加载');
            
            // 等待数据管理器初始化
            setTimeout(() => {
                checkDataManager();
                loadCourseData();
            }, 1000);
        });
        
        // 检查数据管理器状态
        async function checkDataManager() {
            const statusElement = document.getElementById('managerStatus');
            
            try {
                if (window.dataManager && window.courseManager) {
                    statusElement.className = 'status success';
                    statusElement.innerHTML = '<i class="fas fa-check-circle"></i> 数据管理器已正确初始化';
                    
                    // 获取数据统计
                    const stats = await window.dataSyncManager.getDataStatus();
                    if (stats) {
                        statusElement.innerHTML += `<br>当前有 ${stats.totalCourses} 门课程，其中 ${stats.published} 门已发布，${stats.draft} 门草稿，${stats.archived} 门已归档`;
                    }
                } else {
                    statusElement.className = 'status error';
                    statusElement.innerHTML = '<i class="fas fa-exclamation-triangle"></i> 数据管理器未正确初始化';
                }
            } catch (error) {
                statusElement.className = 'status error';
                statusElement.innerHTML = `<i class="fas fa-exclamation-triangle"></i> 检查失败: ${error.message}`;
            }
        }
        
        // 加载课程数据
        async function loadCourseData() {
            const statusElement = document.getElementById('courseDataStatus');
            const previewElement = document.getElementById('courseDataPreview');
            
            try {
                const courses = await window.courseManager.getCourses();
                
                statusElement.className = 'status success';
                statusElement.innerHTML = `<i class="fas fa-check-circle"></i> 成功加载 ${courses.length} 门课程`;
                
                // 显示数据预览
                if (courses.length > 0) {
                    previewElement.innerHTML = JSON.stringify(courses, null, 2);
                } else {
                    previewElement.innerHTML = '暂无课程数据';
                }
            } catch (error) {
                statusElement.className = 'status error';
                statusElement.innerHTML = `<i class="fas fa-exclamation-triangle"></i> 加载失败: ${error.message}`;
                previewElement.innerHTML = '';
            }
        }
        
        // 创建测试课程
        async function createTestCourse() {
            try {
                const testCourse = {
                    id: 'test_' + Date.now(),
                    name: '测试课程 ' + new Date().toLocaleTimeString(),
                    code: 'TEST' + Math.floor(Math.random() * 1000),
                    credit: 2,
                    class: '测试班级',
                    semester: '2023-2024学年秋季',
                    description: '这是一个测试课程，用于验证数据持久化功能',
                    department: '测试系',
                    status: 'draft',
                    allowPreview: true,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };
                
                await window.courseManager.saveCourse(testCourse);
                
                // 重新加载数据
                await loadCourseData();
                
                // 显示成功消息
                document.getElementById('syncStatus').className = 'status success';
                document.getElementById('syncStatus').innerHTML = '<i class="fas fa-check-circle"></i> 测试课程创建成功！';
                
            } catch (error) {
                document.getElementById('syncStatus').className = 'status error';
                document.getElementById('syncStatus').innerHTML = `<i class="fas fa-exclamation-triangle"></i> 创建失败: ${error.message}`;
            }
        }
        
        // 清空所有课程
        async function clearAllCourses() {
            if (!confirm('确定要清空所有课程数据吗？此操作不可恢复！')) {
                return;
            }
            
            try {
                const courses = await window.courseManager.getCourses();
                
                // 删除所有课程
                for (const course of courses) {
                    await window.courseManager.deleteCourse(course.id);
                }
                
                // 重新加载数据
                await loadCourseData();
                
                document.getElementById('syncStatus').className = 'status success';
                document.getElementById('syncStatus').innerHTML = '<i class="fas fa-check-circle"></i> 所有课程已清空';
                
            } catch (error) {
                document.getElementById('syncStatus').className = 'status error';
                document.getElementById('syncStatus').innerHTML = `<i class="fas fa-exclamation-triangle"></i> 清空失败: ${error.message}`;
            }
        }
        
        // 手动同步数据
        async function triggerDataSync() {
            try {
                await window.dataSyncManager.triggerDataSync();
                
                document.getElementById('syncStatus').className = 'status success';
                document.getElementById('syncStatus').innerHTML = '<i class="fas fa-check-circle"></i> 数据同步完成';
                
            } catch (error) {
                document.getElementById('syncStatus').className = 'status error';
                document.getElementById('syncStatus').innerHTML = `<i class="fas fa-exclamation-triangle"></i> 同步失败: ${error.message}`;
            }
        }
        
        // 检查数据一致性
        async function checkDataConsistency() {
            try {
                const result = await window.dataSyncManager.checkDataConsistency();
                
                if (result.isValid) {
                    document.getElementById('syncStatus').className = 'status success';
                    document.getElementById('syncStatus').innerHTML = 
                        `<i class="fas fa-check-circle"></i> 数据一致性检查通过 (${result.totalCourses} 门课程)`;
                } else {
                    document.getElementById('syncStatus').className = 'status error';
                    document.getElementById('syncStatus').innerHTML = 
                        `<i class="fas fa-exclamation-triangle"></i> 发现 ${result.issues.length} 个问题: ${result.issues.join(', ')}`;
                }
                
            } catch (error) {
                document.getElementById('syncStatus').className = 'status error';
                document.getElementById('syncStatus').innerHTML = `<i class="fas fa-exclamation-triangle"></i> 检查失败: ${error.message}`;
            }
        }
        
        // 强制重新加载数据
        async function forceReloadData() {
            if (confirm('确定要强制重新加载数据吗？这将清除缓存并重新初始化所有数据。')) {
                await window.dataSyncManager.forceReload();
            }
        }
        
        // 模拟页面切换测试
        async function testPageSwitch() {
            const statusElement = document.getElementById('pageSwitchStatus');
            
            try {
                // 保存当前数据状态
                const beforeStats = await window.dataSyncManager.getDataStatus();
                
                // 创建测试课程（如果不存在）
                const courses = await window.courseManager.getCourses();
                if (courses.length === 0) {
                    await createTestCourse();
                }
                
                // 模拟页面切换：隐藏页面然后重新显示
                statusElement.className = 'status info';
                statusElement.innerHTML = '<i class="fas fa-sync"></i> 模拟页面切换中...';
                
                // 延迟模拟页面切换
                setTimeout(async () => {
                    // 模拟页面重新加载
                    await loadCourseData();
                    
                    const afterStats = await window.dataSyncManager.getDataStatus();
                    
                    if (afterStats && afterStats.totalCourses === beforeStats.totalCourses) {
                        statusElement.className = 'status success';
                        statusElement.innerHTML = 
                            `<i class="fas fa-check-circle"></i> 页面切换测试通过！数据保持一致性 (${afterStats.totalCourses} 门课程)`;
                    } else {
                        statusElement.className = 'status error';
                        statusElement.innerHTML = 
                            `<i class="fas fa-exclamation-triangle"></i> 页面切换测试失败！数据不一致`;
                    }
                }, 1000);
                
            } catch (error) {
                statusElement.className = 'status error';
                statusElement.innerHTML = `<i class="fas fa-exclamation-triangle"></i> 测试失败: ${error.message}`;
            }
        }
        
        // 打开课程管理页面
        function openCoursesPage() {
            window.open('courses.html', '_blank');
        }
    </script>
</body>
</html>