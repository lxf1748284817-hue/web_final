<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>教学管理员仪表盘 - 成绩管理教学平台</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        body {
            font-family: "Microsoft YaHei", sans-serif;
            background-color: #f8f9fa;
            padding-top: 56px; /* Height of fixed navbar */
        }
        .navbar-brand {
            font-weight: bold;
        }
        .main-content {
            padding: 20px 0;
        }
        .card {
            margin-bottom: 20px;
            box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,0.075);
            border: none;
        }
        .dashboard-card {
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
            height: 100%;
        }
        .dashboard-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.15);
        }
        .dashboard-icon {
            font-size: 2.5rem;
            margin-bottom: 15px;
            color: #0d6efd;
        }
        .schedule-table th, .schedule-table td {
            text-align: center;
            vertical-align: middle;
            height: 60px;
        }
        .schedule-cell {
            background-color: #e3f2fd;
            border-radius: 4px;
            padding: 5px;
            font-size: 0.9em;
        }
        .sortable {
            cursor: pointer;
        }
        .sortable:hover {
            background-color: #f1f1f1;
        }
    </style>
</head>
<body>

<!-- Top Navbar -->
<nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top border-bottom border-secondary">
    <div class="container">
        <a class="navbar-brand" href="#" data-target="dashboard-section">
            <i class="bi bi-mortarboard-fill me-2"></i>教学管理
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                        <i class="bi bi-database"></i> 基础数据
                    </a>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#" data-target="class-section">班级管理</a></li>
                        <li><a class="dropdown-item" href="#" data-target="student-section">学生管理</a></li>
                        <li><a class="dropdown-item" href="#" data-target="course-section">课程管理</a></li>
                        <li><a class="dropdown-item" href="#" data-target="teacher-section">教师管理</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="#" data-target="plan-section">开课计划</a></li>
                    </ul>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" data-target="score-section">
                        <i class="bi bi-check-circle"></i> 成绩审核
                    </a>
                </li>
            </ul>
            <ul class="navbar-nav">
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                        <i class="bi bi-person-circle"></i> 管理员
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" href="#">个人设置</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item text-danger" href="#" onclick="logout()">退出登录</a></li>
                    </ul>
                </li>
            </ul>
        </div>
    </div>
</nav>

<div class="container main-content">
    
    <!-- 0. 仪表盘 (Dashboard) -->
    <div id="dashboard-section" class="content-section">
        <div class="row mb-4">
            <div class="col-12">
                <h2 class="mb-3">欢迎回来，管理员</h2>
                <p class="text-muted">请选择一个模块开始工作</p>
            </div>
        </div>
        <div class="row g-4">
            <!-- Card 1: 班级管理 -->
            <div class="col-md-4 col-sm-6">
                <div class="card dashboard-card text-center p-4" data-target="class-section">
                    <div class="card-body">
                        <i class="bi bi-people-fill dashboard-icon"></i>
                        <h5 class="card-title">班级管理</h5>
                        <p class="card-text text-muted">管理行政班级信息</p>
                    </div>
                </div>
            </div>
            <!-- Card 2: 学生管理 -->
            <div class="col-md-4 col-sm-6">
                <div class="card dashboard-card text-center p-4" data-target="student-section">
                    <div class="card-body">
                        <i class="bi bi-person-badge dashboard-icon"></i>
                        <h5 class="card-title">学生管理</h5>
                        <p class="card-text text-muted">维护学生档案与信息</p>
                    </div>
                </div>
            </div>
            <!-- Card 3: 教师管理 -->
            <div class="col-md-4 col-sm-6">
                <div class="card dashboard-card text-center p-4" data-target="teacher-section">
                    <div class="card-body">
                        <i class="bi bi-person-workspace dashboard-icon"></i>
                        <h5 class="card-title">教师管理</h5>
                        <p class="card-text text-muted">管理教师及授课资格</p>
                    </div>
                </div>
            </div>
            <!-- Card 4: 课程管理 -->
            <div class="col-md-4 col-sm-6">
                <div class="card dashboard-card text-center p-4" data-target="course-section">
                    <div class="card-body">
                        <i class="bi bi-book-half dashboard-icon"></i>
                        <h5 class="card-title">课程管理</h5>
                        <p class="card-text text-muted">设置课程库及学分</p>
                    </div>
                </div>
            </div>
            <!-- Card 5: 开课计划 -->
            <div class="col-md-4 col-sm-6">
                <div class="card dashboard-card text-center p-4" data-target="plan-section">
                    <div class="card-body">
                        <i class="bi bi-calendar-week dashboard-icon"></i>
                        <h5 class="card-title">开课计划</h5>
                        <p class="card-text text-muted">排课与学期教学安排</p>
                    </div>
                </div>
            </div>
            <!-- Card 6: 成绩审核 -->
            <div class="col-md-4 col-sm-6">
                <div class="card dashboard-card text-center p-4" data-target="score-section">
                    <div class="card-body">
                        <i class="bi bi-clipboard-check dashboard-icon"></i>
                        <h5 class="card-title">成绩审核</h5>
                        <p class="card-text text-muted">审核与发布期末成绩</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 1. 班级管理 -->
    <div id="class-section" class="content-section" style="display: none;">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div class="d-flex align-items-center">
                <button class="btn btn-outline-secondary me-3" data-target="dashboard-section">
                    <i class="bi bi-arrow-left"></i> 返回
                </button>
                <h2 class="mb-0"><i class="bi bi-people-fill me-2"></i>班级管理</h2>
            </div>
            <button class="btn btn-primary" onclick="openClassModal()">+ 新增班级</button>
        </div>
        <div class="card">
            <div class="card-body">
                <table class="table table-hover" id="class-table">
                    <thead>
                        <tr>
                            <th class="sortable" onclick="handleSort('class-table', 'id')">ID <i class="bi bi-arrow-down-up"></i></th>
                            <th>班级名称</th>
                            <th>班级人数</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- 2. 学生管理 -->
    <div id="student-section" class="content-section" style="display: none;">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div class="d-flex align-items-center">
                <button class="btn btn-outline-secondary me-3" data-target="dashboard-section">
                    <i class="bi bi-arrow-left"></i> 返回
                </button>
                <h2 class="mb-0"><i class="bi bi-person-badge me-2"></i>学生管理</h2>
            </div>
            <div class="d-flex gap-2 align-items-start">
                <div class="input-group has-validation">
                    <input type="text" class="form-control" id="studentSearch" placeholder="搜索学生..." oninput="this.classList.remove('is-invalid')">
                    <button class="btn btn-outline-secondary" type="button" onclick="handleStudentSearch()">
                        <i class="bi bi-search"></i> 搜索
                    </button>
                    <div class="invalid-feedback">
                        请输入搜索关键词
                    </div>
                </div>
                <button class="btn btn-primary text-nowrap" onclick="openStudentModal()">+ 新增学生</button>
            </div>
        </div>
        <div class="card">
            <div class="card-body">
                <table class="table table-hover" id="student-table">
                    <thead>
                        <tr>
                            <th>头像</th>
                            <th class="sortable" onclick="handleSort('student-table', 'username')">学号 <i class="bi bi-arrow-down-up"></i></th>
                            <th>姓名</th>
                            <th>性别</th>
                            <th>班级</th>
                            <th>手机</th>
                            <th>地区</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- 2.1 学生编辑 (个人中心风格) -->
    <div id="student-edit-section" class="content-section" style="display: none; background-color: #f8f9fa; min-height: calc(100vh - 56px);">
        <!-- Top Navigation Bar (Sub-nav) -->
        <div class="bg-white border-bottom px-4 d-flex justify-content-between align-items-center" style="height: 60px;">
            <div class="d-flex gap-4 h-100">
                <a href="#" class="nav-link-custom active d-flex align-items-center text-decoration-none px-2" style="border-bottom: 3px solid #fd7e14; color: #fd7e14; font-weight: 500;">基本信息</a>
                <a href="#" class="nav-link-custom d-flex align-items-center text-decoration-none px-2 text-secondary" style="border-bottom: 3px solid transparent;">修改密码</a>
            </div>
            <button class="btn btn-sm btn-outline-secondary" onclick="cancelEdit()">
                <i class="bi bi-x-lg"></i> 关闭
            </button>
        </div>

        <!-- Main Content Area -->
        <div class="container py-5">
            <div class="bg-white rounded shadow-sm mx-auto p-5" style="max-width: 800px;">
                <form id="studentEditForm">
                    <input type="hidden" id="editStudentId">
                    
                    <!-- Avatar -->
                    <div class="text-center mb-5">
                        <div class="position-relative d-inline-block">
                            <div class="rounded-circle border border-3 border-white shadow-sm overflow-hidden bg-light" style="width: 120px; height: 120px;">
                                <img id="editStudentAvatar" src="" class="w-100 h-100" style="object-fit: cover; object-position: center;" onclick="triggerAvatarUpload()" alt="用户头像">
                            </div>
                            <button type="button" class="btn btn-sm btn-primary position-absolute bottom-0 end-0 rounded-circle shadow-sm border-2 border-white" onclick="triggerAvatarUpload()" style="width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; z-index: 10;">
                                <i class="bi bi-camera-fill"></i>
                            </button>
                        </div>
                        <input type="file" id="avatarInput" hidden accept="image/*" onchange="handleAvatarChange(this)">
                        <div class="mt-2 text-muted small">点击头像更换图片</div>
                    </div>

                    <!-- Nickname -->
                    <div class="mb-4 row">
                        <label class="col-sm-2 col-form-label fw-bold text-end"><span class="text-danger me-1">*</span>昵称</label>
                        <div class="col-sm-8">
                            <input type="text" class="form-control" id="editStudentUsername" placeholder="请输入昵称 (学号)">
                        </div>
                    </div>

                    <!-- Name -->
                    <div class="mb-4 row">
                        <label class="col-sm-2 col-form-label fw-bold text-end"><span class="text-danger me-1">*</span>姓名</label>
                        <div class="col-sm-8">
                            <input type="text" class="form-control bg-light" id="editStudentName" readonly>
                        </div>
                    </div>

                    <!-- Class (Added for context) -->
                    <div class="mb-4 row">
                        <label class="col-sm-2 col-form-label fw-bold text-end"><span class="text-danger me-1">*</span>班级</label>
                        <div class="col-sm-8">
                            <select class="form-select" id="editStudentClassId"></select>
                        </div>
                    </div>

                    <!-- Gender -->
                    <div class="mb-4 row">
                        <label class="col-sm-2 col-form-label fw-bold text-end"><span class="text-danger me-1">*</span>性别</label>
                        <div class="col-sm-8 d-flex align-items-center gap-4 pt-2">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="gender" id="genderMale" value="male" checked style="border-color: #fd7e14; background-color: #fd7e14;">
                                <label class="form-check-label" for="genderMale">男</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="gender" id="genderFemale" value="female">
                                <label class="form-check-label" for="genderFemale">女</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="gender" id="genderSecret" value="secret">
                                <label class="form-check-label" for="genderSecret">不公开</label>
                            </div>
                        </div>
                    </div>

                    <!-- Email -->
                    <div class="mb-4 row">
                        <label class="col-sm-2 col-form-label fw-bold text-end">邮箱</label>
                        <div class="col-sm-8">
                            <div class="d-flex align-items-center">
                                <span id="editStudentEmail" class="text-secondary me-3">zhangsan@example.com</span>
                                <a href="#" class="text-decoration-none text-primary" onclick="toggleEmailEdit()">修改邮箱</a>
                            </div>
                            <div id="emailEditRow" class="mt-2" style="display: none;">
                                <div class="input-group" style="max-width: 300px;">
                                    <input type="email" class="form-control" id="emailInput" placeholder="输入新邮箱">
                                    <button class="btn btn-outline-primary" type="button" onclick="confirmEmailEdit()">确定</button>
                                    <button class="btn btn-outline-secondary" type="button" onclick="cancelEmailEdit()">取消</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Phone -->
                    <div class="mb-4 row">
                        <label class="col-sm-2 col-form-label fw-bold text-end">手机</label>
                        <div class="col-sm-8">
                            <div class="d-flex align-items-center">
                                <span id="editStudentPhone" class="text-secondary me-3">138****8888</span>
                                <a href="#" class="text-decoration-none text-primary me-3" onclick="togglePhoneEdit()">修改手机</a>
                                <a href="#" class="text-decoration-none text-success" onclick="unbindPhone()">解除绑定</a>
                            </div>
                            <div id="phoneEditRow" class="mt-2" style="display: none;">
                                <div class="input-group" style="max-width: 300px;">
                                    <input type="tel" class="form-control" id="phoneInput" placeholder="输入新手机号">
                                    <button class="btn btn-outline-primary" type="button" onclick="confirmPhoneEdit()">确定</button>
                                    <button class="btn btn-outline-secondary" type="button" onclick="cancelPhoneEdit()">取消</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Birthday -->
                    <div class="mb-4 row">
                        <label class="col-sm-2 col-form-label fw-bold text-end">生日</label>
                        <div class="col-sm-8">
                            <input type="date" class="form-control text-secondary" style="max-width: 200px;">
                        </div>
                    </div>

                    <!-- Region -->
                    <div class="mb-4 row">
                        <label class="col-sm-2 col-form-label fw-bold text-end">地区</label>
                        <div class="col-sm-8">
                            <select class="form-select" style="max-width: 200px;">
                                <option value="" selected disabled>请选择省份</option>
                                <option value="beijing">北京</option>
                                <option value="shanghai">上海</option>
                                <option value="guangdong">广东</option>
                                <option value="zhejiang">浙江</option>
                            </select>
                        </div>
                    </div>

                    <!-- Save Button -->
                    <div class="row mt-5">
                        <div class="col-sm-8 offset-sm-2 text-center">
                            <button type="button" class="btn text-white px-5 py-2" onclick="saveStudentProfile()" style="background-color: #fd7e14; border-radius: 4px;">保存</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- 3. 课程管理 -->
    <div id="course-section" class="content-section" style="display: none;">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div class="d-flex align-items-center">
                <button class="btn btn-outline-secondary me-3" data-target="dashboard-section">
                    <i class="bi bi-arrow-left"></i> 返回
                </button>
                <h2 class="mb-0"><i class="bi bi-book-half me-2"></i>课程管理</h2>
            </div>
            <button class="btn btn-primary" onclick="openCourseModal()">+ 新增课程</button>
        </div>
        <div class="card">
            <div class="card-body">
                <table class="table table-hover" id="course-table">
                    <thead>
                        <tr>
                            <th>课程代码</th>
                            <th>课程名称</th>
                            <th>学分</th>
                            <th>所属院系</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- 4. 教师管理 -->
    <div id="teacher-section" class="content-section" style="display: none;">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div class="d-flex align-items-center">
                <button class="btn btn-outline-secondary me-3" data-target="dashboard-section">
                    <i class="bi bi-arrow-left"></i> 返回
                </button>
                <h2 class="mb-0"><i class="bi bi-person-workspace me-2"></i>教师管理</h2>
            </div>
            <button class="btn btn-primary" onclick="openTeacherModal()">+ 新增教师</button>
        </div>
        <div class="card">
            <div class="card-body">
                <table class="table table-hover" id="teacher-table">
                    <thead>
                        <tr>
                            <th>工号</th>
                            <th>姓名</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- 5. 开课计划与排课管理 -->
    <div id="plan-section" class="content-section" style="display: none;">
        <!-- 顶部操作区 -->
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div class="d-flex align-items-center">
                <button class="btn btn-outline-secondary me-3" data-target="dashboard-section">
                    <i class="bi bi-arrow-left"></i> 返回
                </button>
                <h2 class="mb-0"><i class="bi bi-calendar-week me-2"></i>开课计划与排课管理</h2>
            </div>
            <button class="btn btn-success" onclick="openPlanModal()">
                <i class="bi bi-plus-lg"></i> 新增开课计划
            </button>
        </div>
        
        <!-- 搜索与过滤区 -->
        <div class="card mb-4 shadow-sm">
            <div class="card-body py-3">
                <div class="row g-3 align-items-center">
                    <div class="col-md-4">
                        <div class="input-group">
                            <span class="input-group-text bg-light"><i class="bi bi-search"></i></span>
                            <input type="text" class="form-control" id="planSearchInput" placeholder="搜索课程、教师或教室...">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="planFilterSemester">
                            <option value="">所有学期</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="planFilterTeacher">
                            <option value="">所有教师</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <button class="btn btn-primary w-100" onclick="handlePlanSearch()">
                            <i class="bi bi-funnel"></i> 筛选
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 开课计划列表 -->
        <div class="card mb-4 shadow-sm">
            <div class="card-header bg-white py-3">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0 text-primary"><i class="bi bi-list-ul me-2"></i>计划列表</h5>
                    <span class="badge bg-secondary" id="planCountBadge">共 0 条</span>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover table-striped mb-0 align-middle" id="plan-table">
                        <thead class="table-light">
                            <tr>
                                <th class="ps-4">#</th>
                                <th>课程</th>
                                <th>授课教师</th>
                                <th>学期</th>
                                <th>教室</th>
                                <th>上课时间</th>
                                <th class="text-end pe-4">操作</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
            <div class="card-footer bg-white py-3">
                <nav aria-label="Page navigation">
                    <ul class="pagination justify-content-end mb-0" id="planPagination"></ul>
                </nav>
            </div>
        </div>

        <!-- 课表预览区 -->
        <div class="card shadow-sm">
            <div class="card-header bg-white">
                <ul class="nav nav-tabs card-header-tabs" id="scheduleTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="overall-tab" data-bs-toggle="tab" data-bs-target="#overall-schedule" type="button" role="tab">
                            <i class="bi bi-grid-3x3 me-2"></i>整体课表视图
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="teacher-tab" data-bs-toggle="tab" data-bs-target="#teacher-schedule" type="button" role="tab">
                            <i class="bi bi-person-video3 me-2"></i>教师个人课表
                        </button>
                    </li>
                </ul>
            </div>
            <div class="card-body">
                <div class="tab-content" id="scheduleTabContent">
                    <!-- Tab 1: 整体课表 -->
                    <div class="tab-pane fade show active" id="overall-schedule" role="tabpanel">
                        <div class="d-flex justify-content-end mb-3">
                            <div class="d-flex align-items-center">
                                <label class="me-2 fw-bold">学期：</label>
                                <select class="form-select form-select-sm" id="scheduleSemesterSelect" style="width: 200px;" onchange="renderOverallSchedule()">
                                    <!-- 动态填充 -->
                                </select>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-bordered schedule-table text-center" id="overall-schedule-table">
                                <thead class="table-light">
                                    <tr>
                                        <th style="width: 100px;">节次 / 星期</th>
                                        <th>周一</th>
                                        <th>周二</th>
                                        <th>周三</th>
                                        <th>周四</th>
                                        <th>周五</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                        <div class="mt-2 small text-muted">
                            <i class="bi bi-square-fill text-danger me-1"></i> 红色背景表示存在教室或时间冲突
                        </div>
                    </div>
                    
                    <!-- Tab 2: 教师个人课表 -->
                    <div class="tab-pane fade" id="teacher-schedule" role="tabpanel">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="mb-0" id="teacherScheduleTitle">请选择教师查看课表</h5>
                            <div class="d-flex align-items-center gap-3">
                                <div class="d-flex align-items-center">
                                    <label class="me-2 fw-bold">学期：</label>
                                    <select class="form-select form-select-sm" id="teacherScheduleSemester" style="width: 180px;" onchange="renderTeacherSchedule()">
                                    </select>
                                </div>
                                <div class="d-flex align-items-center">
                                    <label class="me-2 fw-bold">教师：</label>
                                    <select class="form-select form-select-sm" id="teacherScheduleSelect" style="width: 180px;" onchange="renderTeacherSchedule()">
                                        <option value="">请选择...</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-bordered schedule-table text-center" id="teacher-schedule-table">
                                <thead class="table-light">
                                    <tr>
                                        <th style="width: 100px;">节次 / 星期</th>
                                        <th>周一</th>
                                        <th>周二</th>
                                        <th>周三</th>
                                        <th>周四</th>
                                        <th>周五</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 6. 成绩审核 -->
    <div id="score-section" class="content-section" style="display: none;">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div class="d-flex align-items-center">
                <button class="btn btn-outline-secondary me-3" data-target="dashboard-section">
                    <i class="bi bi-arrow-left"></i> 返回
                </button>
                <h2 class="mb-0"><i class="bi bi-clipboard-check me-2"></i>成绩审核与发布</h2>
            </div>
            <button class="btn btn-outline-secondary" onclick="exportAllScores()">导出所有报表</button>
        </div>
        <div class="alert alert-info">
            <i class="bi bi-info-circle"></i> 红色背景行表示数据异常（优秀率>60% 或 及格率<70%），请重点审核。
        </div>
        <div class="card">
            <div class="card-body">
                <table class="table table-hover align-middle" id="score-audit-table">
                    <thead>
                        <tr>
                            <th>课程名称</th>
                            <th>授课教师</th>
                            <th>学生人数</th>
                            <th>平均分</th>
                            <th>优秀率</th>
                            <th>及格率</th>
                            <th>状态</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

</div>

<!-- Modals -->

<!-- Class Modal -->
<div class="modal fade" id="classModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="classModalLabel">编辑班级</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="classForm">
                    <input type="hidden" id="classId">
                    <div class="mb-3">
                        <label class="form-label" for="className">班级名称</label>
                        <input type="text" class="form-control" id="className" name="name" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="saveClass()">保存</button>
            </div>
        </div>
    </div>
</div>

<!-- Student Modal -->
<div class="modal fade" id="studentModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="studentModalLabel">编辑学生</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="studentForm">
                    <input type="hidden" id="studentId">
                    <div class="mb-3">
                        <label class="form-label" for="studentUsername">学号 (Username)</label>
                        <input type="text" class="form-control" id="studentUsername" name="username" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label" for="studentName">姓名</label>
                        <input type="text" class="form-control" id="studentName" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label" for="studentClassId">所属班级</label>
                        <select class="form-select" id="studentClassId" name="classId" required></select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="saveStudent()">保存</button>
            </div>
        </div>
    </div>
</div>

<!-- Teacher Modal -->
<div class="modal fade" id="teacherModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="teacherModalLabel">编辑教师</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="teacherForm">
                    <input type="hidden" id="teacherId">
                    <div class="mb-3">
                        <label class="form-label" for="teacherUsername">工号 (Username)</label>
                        <input type="text" class="form-control" id="teacherUsername" name="username" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label" for="teacherName">姓名</label>
                        <input type="text" class="form-control" id="teacherName" name="name" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="saveTeacher()">保存</button>
            </div>
        </div>
    </div>
</div>

<!-- Course Modal -->
<div class="modal fade" id="courseModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="courseModalLabel">编辑课程</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="courseForm">
                    <input type="hidden" id="courseId">
                    <div class="mb-3">
                        <label class="form-label" for="courseCode">课程代码</label>
                        <input type="text" class="form-control" id="courseCode" name="code" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label" for="courseName">课程名称</label>
                        <input type="text" class="form-control" id="courseName" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label" for="courseCredits">学分</label>
                        <input type="number" class="form-control" id="courseCredits" name="credits" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label" for="courseDept">所属院系</label>
                        <input type="text" class="form-control" id="courseDept" name="department" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="saveCourse()">保存</button>
            </div>
        </div>
    </div>
</div>

<!-- Plan Modal -->
<div class="modal fade" id="planModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-light">
                <h5 class="modal-title" id="planModalLabel"><i class="bi bi-calendar-plus me-2"></i>编辑开课计划</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="planForm">
                    <input type="hidden" id="planId">
                    
                    <div class="row g-3 mb-3">
                        <div class="col-md-6">
                            <label class="form-label fw-bold">选择课程 <span class="text-danger">*</span></label>
                            <select class="form-select" id="planCourseId" name="courseId" required></select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">授课教师 <span class="text-danger">*</span></label>
                            <select class="form-select" id="planTeacherId" name="teacherId" required></select>
                        </div>
                    </div>

                    <div class="row g-3 mb-3">
                        <div class="col-md-6">
                            <label class="form-label fw-bold">学期 <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="planSemester" name="semester" placeholder="例如: 2024-2025-1" list="semesterOptions" required>
                            <datalist id="semesterOptions">
                                <option value="2024-2025-1">
                                <option value="2024-2025-2">
                                <option value="2025-2026-1">
                            </datalist>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">教室 <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="planClassroom" name="classroom" placeholder="例如: A101" required>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">上课时间安排 <span class="text-danger">*</span></label>
                        <div class="card bg-light border-0">
                            <div class="card-body">
                                <!-- 星期选择 -->
                                <div class="mb-3">
                                    <label class="form-label small text-muted mb-2">选择星期 (多选)</label>
                                    <div class="d-flex flex-wrap gap-3" id="planDaysCheckboxes">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="planDay" value="周一" id="dayMon">
                                            <label class="form-check-label" for="dayMon">周一</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="planDay" value="周二" id="dayTue">
                                            <label class="form-check-label" for="dayTue">周二</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="planDay" value="周三" id="dayWed">
                                            <label class="form-check-label" for="dayWed">周三</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="planDay" value="周四" id="dayThu">
                                            <label class="form-check-label" for="dayThu">周四</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="planDay" value="周五" id="dayFri">
                                            <label class="form-check-label" for="dayFri">周五</label>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- 节次选择 -->
                                <div class="mb-3">
                                    <label class="form-label small text-muted mb-2">选择节次 (多选)</label>
                                    <div class="d-flex flex-wrap gap-3" id="planSlotsCheckboxes">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="planSlot" value="1" id="slot1">
                                            <label class="form-check-label" for="slot1">第1节</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="planSlot" value="2" id="slot2">
                                            <label class="form-check-label" for="slot2">第2节</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="planSlot" value="3" id="slot3">
                                            <label class="form-check-label" for="slot3">第3节</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="planSlot" value="4" id="slot4">
                                            <label class="form-check-label" for="slot4">第4节</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="planSlot" value="5" id="slot5">
                                            <label class="form-check-label" for="slot5">第5节</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="planSlot" value="6" id="slot6">
                                            <label class="form-check-label" for="slot6">第6节</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="planSlot" value="7" id="slot7">
                                            <label class="form-check-label" for="slot7">第7节</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="planSlot" value="8" id="slot8">
                                            <label class="form-check-label" for="slot8">第8节</label>
                                        </div>
                                    </div>
                                </div>

                                <!-- 周数类型 -->
                                <div>
                                    <label class="form-label small text-muted mb-2">周数类型</label>
                                    <div class="d-flex gap-4">
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="weekType" id="weekAll" value="all" checked>
                                            <label class="form-check-label" for="weekAll">每周</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="weekType" id="weekOdd" value="odd">
                                            <label class="form-check-label" for="weekOdd">单周</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="weekType" id="weekEven" value="even">
                                            <label class="form-check-label" for="weekEven">双周</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">最大选课人数</label>
                        <input type="number" class="form-control" id="planMaxStudents" name="maxStudents" value="50">
                    </div>
                    
                    <div id="conflictAlert" class="alert alert-danger d-none">
                        <i class="bi bi-exclamation-triangle-fill me-2"></i> <span id="conflictMsg">检测到冲突</span>
                    </div>

                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="savePlan()">保存</button>
            </div>
        </div>
    </div>
</div>

<!-- Score Detail Modal -->
<div class="modal fade" id="scoreDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">成绩明细</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3 d-flex justify-content-between">
                    <h6 id="scoreDetailTitle"></h6>
                    <span class="badge bg-warning text-dark" id="scoreDetailWarning" style="display:none">存在异常波动学生</span>
                </div>
                <table class="table table-sm table-bordered" id="score-detail-table">
                    <thead>
                        <tr>
                            <th>学号</th>
                            <th>姓名</th>
                            <th>平时成绩</th>
                            <th>期末成绩</th>
                            <th>总评</th>
                            <th>异常检测</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>

<!-- Class Students Modal -->
<div class="modal fade" id="classStudentsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="classStudentsModalLabel">班级学生列表</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <table class="table table-striped table-hover" id="class-students-table">
                    <thead>
                        <tr>
                            <th>学号</th>
                            <th>姓名</th>
                            <th>性别</th>
                            <th>生源地</th>
                            <th>联系电话</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script type="module">
    // 导入统一服务
    // DatabaseManager 使用默认导出，直接导入
    import '../shared/DatabaseManager.js';
    // AuthService 使用默认导出，直接导入
    import '../shared/AuthService.js';

    // 兼容现有代码
    window.dbManager = dbManager;
    window.authService = authService;

    // 初始化系统
    document.addEventListener('DOMContentLoaded', async () => {
        try {
            // 检查登录状态
            const session = await authService.checkSession();
            if (!session || session.role !== 'admin_edu') {
                alert('请先登录教学管理端！');
                window.location.href = '../public/login.html?role=admin_edu';
                return;
            }

            // 初始化数据库
            await dbManager.init();
            
            // 加载现有脚本
            await loadScript('js/admin.js?v=3');
            
            // 等待脚本加载完成
            await new Promise(resolve => setTimeout(resolve, 200));
            
            // 检查 admin.js 是否正确加载，但不重复触发 DOMContentLoaded
            if (typeof loadAllData === 'function') {
                console.log('✅ admin.js 加载完成，检查是否需要初始化数据');
                
                // 检查是否已经有数据，如果没有则初始化
                try {
                    const classes = await window.dbManager.getAll('classes');
                    console.log('🔍 调试 - 数据检查，classes数量:', classes?.length || 0);
                    
                    if (classes && classes.length === 0) {
                        console.log('🔄 首次加载，初始化数据');
                        loadAllData();
                    } else {
                        console.log('✅ 数据已存在，渲染现有数据');
                        console.log('🔍 调试 - 检查DOM元素:');
                        console.log('班级表格:', document.querySelector('#class-table tbody'));
                        console.log('课程表格:', document.querySelector('#course-table tbody'));
                        console.log('计划表格:', document.querySelector('#plan-table tbody'));
                        
                        // 加载所有数据
                        const plans = await window.dbManager.getAll('plans');
                        const courses = await window.dbManager.getAll('courses');
                        const users = await window.dbManager.getAll('users');
                        
                        // 设置全局变量供其他函数使用
                        window.currentPlans = plans;
                        window.currentCourses = courses;
                        window.currentUsers = users;
                        
                        console.log('🔍 数据加载情况:');
                        console.log('用户数量:', users.length);
                        console.log('学生数量:', users.filter(u => u.role === 'student').length);
                        console.log('教师数量:', users.filter(u => u.role === 'teacher').length);
                        
                        // 渲染所有数据
                        renderClasses(classes);
                        renderCourses(courses);
                        renderPlans(plans);
                        renderStudents();
                        renderTeachers();
                        
                        // 检查事件绑定
                        setTimeout(() => {
                            console.log('🔍 调试 - 检查事件绑定:');
                            console.log('导航链接数量:', document.querySelectorAll('.navbar-nav .nav-link').length);
                            console.log('仪表盘卡片数量:', document.querySelectorAll('.dashboard-card').length);
                            console.log('Bootstrap是否加载:', typeof bootstrap !== 'undefined');
                        }, 100);
                    }
                } catch (error) {
                    console.error('❌ 数据加载失败:', error);
                }
            } else {
                console.error('❌ admin.js 未正确加载');
                // 如果admin.js未加载，重新加载页面
                window.location.reload();
            }

        } catch (error) {
            console.error('❌ 教学管理端初始化失败:', error);
            alert('系统初始化失败，请刷新页面重试');
        }
    });

    // 动态加载脚本
    function loadScript(src) {
        return new Promise((resolve, reject) => {
            const script = document.createElement('script');
            script.src = src;
            script.onload = resolve;
            script.onerror = reject;
            document.head.appendChild(script);
        });
    }
</script>
</body>
</html>
